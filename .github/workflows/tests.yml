name: INTEGRATION AND UNIT TESTS

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

jobs:
  integration-tests:
    name: Build and Test Everything (INTEGRATION TEST)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check. All auth_utils.py files must be identical
        run: |
          find . -name "auth_utils.py" -exec md5sum {} + | awk '{print $1}' | uniq -c | awk '$1 != 1 {exit 1}'

      - name: Build and run the whole system using Docker Compose
        run: docker compose -f src/docker-compose.yml up -d

      - name: Install Node.js
        uses: actions/setup-node@v4

      - name: Install Newman
        run: npm install -g newman

      - name: Run the tests
        # TODO: prendere le env var direttamente da postman?
        # TODO: usare .json come chiesto da professore invece che API?
        run: newman run "https://api.postman.com/collections/26720283-80745346-aaa6-4cff-b0dd-137edb46a5f3?access_key=${{ secrets.POSTMAN_ACCESS_KEY }}" --env-var "GATEWAY_URL=http://localhost:5001" --env-var "ADMIN_GATEWAY_URL=http://localhost:5002"
      
      - name: Output Docker Compose logs
        if: always()
        run: docker compose -f src/docker-compose.yml logs

      - name: Stop Docker Compose
        run: docker compose -f src/docker-compose.yml down
